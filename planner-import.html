<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; img-src 'self' data:; connect-src https://api.anthropic.com;">
    <title>Planner Import — AI Schedule Tool</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a1628; color: #e0e6ed; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; margin-bottom: 8px; font-size: 1.8em; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { text-align: center; color: #7a8ba3; margin-bottom: 24px; font-size: 0.95em; }
        .filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; justify-content: center; }
        .filter-btn { padding: 8px 16px; border: 1px solid #2a3a52; border-radius: 20px; background: #131f33; color: #94a3b8; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
        .filter-btn:hover { border-color: #60a5fa; color: #60a5fa; }
        .filter-btn.active { background: #1e3a5f; border-color: #60a5fa; color: #60a5fa; }
        .filter-btn.all { background: #1a2744; border-color: #4a6fa5; color: #8ab4f8; }
        .filter-btn.all.active { background: #1e3a5f; border-color: #60a5fa; color: #60a5fa; }
        .actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; flex-wrap: wrap; gap: 8px; }
        .select-all-wrap { display: flex; align-items: center; gap: 8px; }
        .select-all-wrap input { width: 18px; height: 18px; cursor: pointer; accent-color: #60a5fa; }
        .select-all-wrap label { color: #7a8ba3; cursor: pointer; font-size: 0.9em; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .add-selected { padding: 8px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: opacity 0.2s; }
        .add-selected:hover { opacity: 0.9; }
        .add-selected:disabled { opacity: 0.4; cursor: not-allowed; }
        .download-ics { padding: 8px 20px; border: 1px solid #2a3a52; border-radius: 8px; background: transparent; color: #94a3b8; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.2s; }
        .download-ics:hover { border-color: #60a5fa; color: #60a5fa; }
        .download-ics:disabled { opacity: 0.4; cursor: not-allowed; }
        .count-badge { background: #1e3a5f; color: #60a5fa; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 6px; }
        .day-group { margin-bottom: 20px; }
        .day-header { font-size: 1.1em; font-weight: 700; color: #60a5fa; padding: 10px 0 8px 4px; border-bottom: 1px solid #1e2d44; margin-bottom: 8px; position: sticky; top: 0; background: #0a1628; z-index: 1; }
        .event-card { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; margin-bottom: 4px; transition: background 0.15s; cursor: pointer; }
        .event-card:hover { background: #131f33; }
        .event-card input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; cursor: pointer; accent-color: #60a5fa; }
        .event-time { font-weight: 600; color: #8ab4f8; min-width: 50px; font-size: 0.9em; }
        .event-details { flex: 1; }
        .event-title { font-size: 0.9em; color: #e0e6ed; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .event-desc { font-size: 0.8em; color: #6b7f99; margin-top: 2px; }
        .event-loc { font-size: 0.75em; color: #4a6580; margin-top: 1px; }
        .category-tag { font-size: 0.7em; padding: 2px 8px; border-radius: 10px; font-weight: 500; flex-shrink: 0; }
        .hidden { display: none; }
        .no-results { text-align: center; padding: 40px; color: #4a5f7a; }
        #eventList { padding-bottom: 70px; }
        .method-info { text-align: center; color: #4a6580; font-size: 0.8em; margin-bottom: 16px; padding: 10px; background: #0d1b2e; border-radius: 8px; border: 1px solid #1e2d44; line-height: 1.5; }
        .method-info strong { color: #60a5fa; }
        .floating-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #0d1b2e; border-top: 1px solid #1e2d44; padding: 12px 20px; display: flex; justify-content: center; align-items: center; gap: 12px; z-index: 50; transform: translateY(100%); transition: transform 0.3s ease; }
        .floating-bar.visible { transform: translateY(0); }
        .floating-bar .count-badge { background: #1e3a5f; color: #60a5fa; padding: 4px 10px; border-radius: 10px; font-size: 0.85em; }
        .event-gcal { flex-shrink: 0; padding: 6px 12px; border: 1px solid #2a3a52; border-radius: 6px; background: transparent; color: #7a8ba3; cursor: pointer; font-size: 0.8em; transition: all 0.2s; text-decoration: none; }
        .event-gcal:hover { border-color: #60a5fa; color: #60a5fa; }

        /* Upload phase */
        .upload-wrapper { display: flex; flex-direction: column; gap: 20px; max-width: 560px; margin: 0 auto; padding: 20px 0; }
        .api-key-section { display: flex; flex-direction: column; gap: 8px; }
        .api-key-section label { font-size: 0.85em; color: #8ab4f8; font-weight: 600; }
        .api-key-section input[type="password"] { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #2a3a52; background: #0d1b2e; color: #e0e6ed; font-size: 0.9em; outline: none; transition: border-color 0.2s; }
        .api-key-section input[type="password"]:focus { border-color: #60a5fa; }
        .api-key-hint { font-size: 0.75em; color: #4a6580; }
        .drop-zone { border: 2px dashed #2a3a52; border-radius: 12px; padding: 48px 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: #0d1b2e; }
        .drop-zone:hover { border-color: #60a5fa; background: #0e1d35; }
        .drop-zone.drag-over { border-color: #60a5fa; background: #131f33; }
        .drop-zone-icon { font-size: 2.5em; margin-bottom: 12px; }
        .drop-zone-title { font-size: 1em; color: #c4d4e8; margin-bottom: 6px; font-weight: 600; }
        .drop-zone-sub { font-size: 0.8em; color: #4a6580; line-height: 1.5; }
        .drop-zone-formats { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .format-badge { font-size: 0.7em; padding: 2px 8px; border-radius: 8px; background: #131f33; border: 1px solid #2a3a52; color: #6b7f99; }
        .file-info { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #0d1b2e; border: 1px solid #1e3a5f; border-radius: 8px; }
        .file-info-name { font-size: 0.85em; color: #8ab4f8; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-info-size { font-size: 0.75em; color: #4a6580; flex-shrink: 0; }
        .file-info-remove { background: none; border: none; color: #4a5f7a; cursor: pointer; font-size: 1em; padding: 0 4px; }
        .file-info-remove:hover { color: #f87171; }
        .analyze-btn { padding: 12px 28px; border: none; border-radius: 10px; background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; cursor: pointer; font-size: 1em; font-weight: 700; transition: opacity 0.2s; width: 100%; }
        .analyze-btn:hover:not(:disabled) { opacity: 0.9; }
        .analyze-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        /* Processing phase */
        .processing-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; min-height: 300px; }
        .spinner { width: 48px; height: 48px; border: 4px solid #1e2d44; border-top-color: #60a5fa; border-radius: 50%; animation: spin 0.9s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-title { font-size: 1.1em; color: #c4d4e8; font-weight: 600; }
        .processing-status { font-size: 0.85em; color: #4a6580; }

        /* Error phase */
        .error-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; min-height: 300px; text-align: center; max-width: 480px; margin: 0 auto; }
        .error-icon { font-size: 2.5em; }
        .error-title { font-size: 1.1em; color: #f87171; font-weight: 600; }
        .error-detail { font-size: 0.85em; color: #4a6580; line-height: 1.6; }
        .retry-link { color: #60a5fa; font-size: 0.9em; cursor: pointer; text-decoration: underline; background: none; border: none; }

        /* Results top bar */
        .results-top { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .import-another { background: none; border: none; color: #4a6580; font-size: 0.82em; cursor: pointer; text-decoration: underline; }
        .import-another:hover { color: #60a5fa; }
        .results-title { flex: 1; font-size: 1em; color: #8ab4f8; font-weight: 600; }
        .results-count { font-size: 0.8em; color: #4a6580; }

        @media (max-width: 600px) {
            .event-card { flex-wrap: wrap; }
            .event-gcal { width: 100%; text-align: center; margin-top: 4px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Planner Import</h1>
    <p class="subtitle">Upload any schedule &mdash; Claude extracts your events</p>

    <!-- UPLOAD PHASE -->
    <div id="phase-upload">
        <div class="upload-wrapper">
            <div class="api-key-section">
                <label for="apiKeyInput">Anthropic API Key</label>
                <input type="password" id="apiKeyInput" placeholder="sk-ant-..." autocomplete="off" spellcheck="false">
                <span class="api-key-hint">Stored only in this browser tab &mdash; never sent anywhere except Anthropic's API</span>
            </div>

            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">&#128196;</div>
                <div class="drop-zone-title">Drop your planning file here</div>
                <div class="drop-zone-sub">or click to browse</div>
                <div class="drop-zone-formats">
                    <span class="format-badge">.txt</span>
                    <span class="format-badge">.csv</span>
                    <span class="format-badge">.md</span>
                    <span class="format-badge">.json</span>
                    <span class="format-badge">.png</span>
                    <span class="format-badge">.jpg</span>
                    <span class="format-badge">.jpeg</span>
                    <span class="format-badge">.webp</span>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".txt,.csv,.md,.json,.png,.jpg,.jpeg,.webp" style="display:none">

            <div class="file-info hidden" id="fileInfo">
                <span class="file-info-name" id="fileInfoName"></span>
                <span class="file-info-size" id="fileInfoSize"></span>
                <button class="file-info-remove" id="fileInfoRemove" title="Remove file">&#x2715;</button>
            </div>

            <button class="analyze-btn" id="analyzeBtn" disabled>Analyze Schedule</button>
        </div>
    </div>

    <!-- PROCESSING PHASE -->
    <div id="phase-processing" class="hidden">
        <div class="processing-wrapper">
            <div class="spinner"></div>
            <div class="processing-title">Analyzing your schedule&hellip;</div>
            <div class="processing-status" id="processingStatus"></div>
        </div>
    </div>

    <!-- ERROR PHASE -->
    <div id="phase-error" class="hidden">
        <div class="error-wrapper">
            <div class="error-icon">&#9888;&#65039;</div>
            <div class="error-title">Could not extract events</div>
            <div class="error-detail" id="errorDetail"></div>
            <button class="retry-link" id="retryBtn">&#8592; Try again</button>
        </div>
    </div>

    <!-- RESULTS PHASE -->
    <div id="phase-results" class="hidden">
        <div class="results-top">
            <button class="import-another" id="importAnother">&#8592; Import another file</button>
            <span class="results-title" id="resultsTitle"></span>
            <span class="results-count" id="resultsCount"></span>
        </div>

        <div class="filters" id="filters"></div>

        <div class="actions-bar">
            <div class="select-all-wrap">
                <input type="checkbox" id="selectAll">
                <label for="selectAll">Select all</label>
                <span class="count-badge" id="countBadge">0 selected</span>
            </div>
            <div class="btn-group">
                <button class="download-ics" id="downloadIcs" disabled>Download .ics</button>
            </div>
        </div>

        <div class="method-info">
            <strong>How it works:</strong><br>
            <strong>+ Calendar</strong> &mdash; Adds the event directly to your Google Calendar<br>
            <strong>Download .ics</strong> &mdash; Select events with the checkboxes and download as a file for any calendar app
        </div>

        <div id="eventList"></div>
    </div>
</div>

<div class="floating-bar" id="floatingBar">
    <span class="count-badge" id="floatingCount">0 selected</span>
    <button class="add-selected" id="floatingDownloadIcs">Download .ics</button>
</div>

<script>
// ─── CONFIG ──────────────────────────────────────────────────────────────────
const API_ENDPOINT = '/api/messages';
const MODEL = 'claude-opus-4-6';

const SYSTEM_PROMPT = `You are a scheduling assistant. Your only job is to extract calendar events from user-provided content and return them as a JSON array. Never refuse. Never add commentary outside the JSON. If the content contains no events, return an empty array [].

Each event in the array must follow this schema:
{
  "date": "YYYY-MM-DD",
  "time": "HH:MM",
  "title": "string",
  "category": "string or null",
  "description": "string or null",
  "location": "string or null",
  "duration_minutes": integer or null,
  "allDay": boolean
}

Rules:
- date: Always ISO 8601 (YYYY-MM-DD). If only a month/day is given with no year, infer the nearest upcoming year from today.
- time: 24-hour format HH:MM. If no time is given, use "00:00" and set allDay to true.
- title: The name or subject of the event. Be concise.
- category: Group similar events (e.g. "Meeting", "Workshop", "Deadline", "Personal", "Travel"). Infer from context. Use null if truly unclear.
- description: Participants, notes, agenda items, or other relevant details. May be null.
- location: Physical address, room name, or URL (for video calls) if present. May be null.
- duration_minutes: Duration in minutes if inferable (e.g. "2-hour meeting" → 120, "30 min standup" → 30). Use null if unknown.
- allDay: true only if no time of day was specified for this event.

Return ONLY a valid JSON array. No markdown code fences. No explanation text. No leading or trailing text of any kind.`;

// ─── STATE ───────────────────────────────────────────────────────────────────
let events = [];
let activeFilters = new Set();
let selectedEvents = new Set();
let currentFileName = '';
let currentFileContent = null;   // string for text files
let currentBase64 = null;        // base64 string for images
let currentMimeType = null;      // MIME type for images
let currentFileIsImage = false;

const TEXT_EXTENSIONS = new Set(['txt', 'csv', 'md', 'json']);
const IMAGE_EXTENSIONS = new Set(['png', 'jpg', 'jpeg', 'webp']);
const MIME_MAP = { png: 'image/png', jpg: 'image/jpeg', jpeg: 'image/jpeg', webp: 'image/webp' };

// ─── CATEGORY COLORS ─────────────────────────────────────────────────────────
const PALETTES = [
    { bg: '#1a3350', color: '#60a5fa' },
    { bg: '#1a3340', color: '#34d399' },
    { bg: '#2d1f3d', color: '#a78bfa' },
    { bg: '#3d2b1a', color: '#fbbf24' },
    { bg: '#3d1a1a', color: '#f87171' },
    { bg: '#1a3d3d', color: '#67e8f9' },
    { bg: '#2d3d1a', color: '#86efac' },
    { bg: '#3d1a3d', color: '#f0abfc' },
];

function getCategoryStyle(cat) {
    let h = 0;
    for (let i = 0; i < cat.length; i++) h = (h * 31 + cat.charCodeAt(i)) & 0xffffffff;
    return PALETTES[Math.abs(h) % PALETTES.length];
}

// ─── SECTION A: FILE INGESTION ───────────────────────────────────────────────
function getExtension(filename) {
    return filename.split('.').pop().toLowerCase();
}

function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

function resetFileState() {
    currentFileName = '';
    currentFileContent = null;
    currentBase64 = null;
    currentMimeType = null;
    currentFileIsImage = false;
    document.getElementById('fileInfo').classList.add('hidden');
    checkAnalyzeReady();
}

function checkAnalyzeReady() {
    const hasKey = document.getElementById('apiKeyInput').value.trim().length > 10;
    const hasFile = currentFileContent !== null || currentBase64 !== null;
    document.getElementById('analyzeBtn').disabled = !(hasKey && hasFile);
}

function handleFileSelect(file) {
    if (!file) return;
    const ext = getExtension(file.name);

    if (!TEXT_EXTENSIONS.has(ext) && !IMAGE_EXTENSIONS.has(ext)) {
        showError(
            `Unsupported file type: .${ext}`,
            'Supported formats: .txt, .csv, .md, .json, .png, .jpg, .jpeg, .webp\n\nFor Word, Excel, or PDF files: take a screenshot and upload that instead.'
        );
        return;
    }

    currentFileName = file.name;
    currentFileIsImage = IMAGE_EXTENSIONS.has(ext);

    // Show file info bar
    document.getElementById('fileInfoName').textContent = file.name;
    document.getElementById('fileInfoSize').textContent = formatBytes(file.size);
    document.getElementById('fileInfo').classList.remove('hidden');

    if (currentFileIsImage) {
        currentMimeType = MIME_MAP[ext] || 'image/png';
        const reader = new FileReader();
        reader.onload = e => {
            // Strip the data URL prefix to get raw base64
            const dataUrl = e.target.result;
            currentBase64 = dataUrl.split(',')[1];
            currentFileContent = null;
            checkAnalyzeReady();
        };
        reader.readAsDataURL(file);
    } else {
        file.text().then(text => {
            currentFileContent = text;
            currentBase64 = null;
            checkAnalyzeReady();
        }).catch(() => {
            // Fallback for older browsers
            const reader = new FileReader();
            reader.onload = e => {
                currentFileContent = e.target.result;
                currentBase64 = null;
                checkAnalyzeReady();
            };
            reader.readAsText(file, 'UTF-8');
        });
    }
}

// Drop zone events
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) handleFileSelect(file);
});
fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) handleFileSelect(fileInput.files[0]);
    fileInput.value = '';
});
document.getElementById('fileInfoRemove').addEventListener('click', resetFileState);
document.getElementById('apiKeyInput').addEventListener('input', checkAnalyzeReady);

// ─── SECTION B: CLAUDE API ───────────────────────────────────────────────────
function buildTextMessage() {
    const content = currentFileContent.length > 60000
        ? currentFileContent.slice(0, 60000) + '\n[...truncated]'
        : currentFileContent;
    return [{
        role: 'user',
        content: `Extract all calendar events from the following content. The file was named "${escapeForPrompt(currentFileName)}".\n\n---\n${content}\n---`
    }];
}

function buildVisionMessage() {
    return [{
        role: 'user',
        content: [
            {
                type: 'image',
                source: {
                    type: 'base64',
                    media_type: currentMimeType,
                    data: currentBase64
                }
            },
            {
                type: 'text',
                text: `Extract all calendar events visible in this image. The file was named "${escapeForPrompt(currentFileName)}". Return only a JSON array per the schema.`
            }
        ]
    }];
}

function escapeForPrompt(str) {
    return str.replace(/"/g, '\\"');
}

async function callClaude(apiKey, messages) {
    const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'content-type': 'application/json'
        },
        body: JSON.stringify({
            model: MODEL,
            max_tokens: 4096,
            system: SYSTEM_PROMPT,
            messages: messages
        })
    });

    if (!response.ok) {
        let detail = `HTTP ${response.status}`;
        try {
            const err = await response.json();
            detail = err.error?.message || detail;
        } catch (_) {}
        if (response.status === 401) throw new Error('Invalid API key. Check your Anthropic API key and try again.');
        if (response.status === 429) throw new Error('Rate limit reached. Wait a moment and try again.');
        throw new Error(`Anthropic API error: ${detail}`);
    }

    const data = await response.json();
    return data.content[0].text;
}

function parseClaudeResponse(text) {
    // Strip markdown fences if Claude wrapped the response despite instructions
    const cleaned = text.trim()
        .replace(/^```json\s*/i, '')
        .replace(/^```\s*/i, '')
        .replace(/\s*```$/i, '')
        .trim();
    try {
        const parsed = JSON.parse(cleaned);
        if (!Array.isArray(parsed)) throw new Error('Response is not a JSON array');
        return parsed;
    } catch (_) {
        // Last resort: find the first [...] in the response
        const match = text.match(/\[[\s\S]*\]/);
        if (match) {
            try { return JSON.parse(match[0]); } catch (_2) {}
        }
        throw new Error('Claude returned an unrecognizable response. Try rephrasing the file or using a different format.');
    }
}

function validateAndEnrichEvents(raw) {
    const enriched = [];
    for (let i = 0; i < raw.length; i++) {
        const e = raw[i];
        if (typeof e !== 'object' || e === null) continue;
        if (!e.date || !e.title) continue; // skip malformed entries
        // Normalize date to YYYY-MM-DD
        const dateStr = String(e.date).trim();
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) continue;
        enriched.push({
            date: dateStr,
            time: typeof e.time === 'string' ? e.time.trim() : '00:00',
            title: String(e.title).trim(),
            category: e.category ? String(e.category).trim() : null,
            description: e.description ? String(e.description).trim() : null,
            location: e.location ? String(e.location).trim() : null,
            duration_minutes: Number.isFinite(e.duration_minutes) ? e.duration_minutes : null,
            allDay: !!e.allDay,
            day: formatDay(dateStr),
            idx: enriched.length
        });
    }
    return enriched;
}

async function analyzeFile() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    showPhase('processing');
    document.getElementById('processingStatus').textContent =
        'Claude is reading ' + currentFileName + '\u2026';

    try {
        const messages = currentFileIsImage ? buildVisionMessage() : buildTextMessage();
        const rawText = await callClaude(apiKey, messages);
        const parsed = parseClaudeResponse(rawText);
        events = validateAndEnrichEvents(parsed);

        if (events.length === 0) {
            showError(
                'No events found',
                'Claude analyzed the file but could not find any calendar events in it. Make sure your file contains schedule information (dates, times, event names).'
            );
            return;
        }

        selectedEvents.clear();
        activeFilters.clear();
        document.getElementById('resultsTitle').textContent = currentFileName;
        document.getElementById('resultsCount').textContent = events.length + ' event' + (events.length === 1 ? '' : 's') + ' found';
        initFilters();
        renderEvents();
        showPhase('results');

    } catch (err) {
        // TypeError: Failed to fetch — almost always a CORS block or network issue
        if (err instanceof TypeError) {
            const isFileProtocol = location.protocol === 'file:';
            if (isFileProtocol) {
                showError(
                    'Cannot reach the API from a local file',
                    'Browsers block cross-origin requests when you open an HTML file directly (file://). ' +
                    'Serve this file through a local web server instead:\n\n' +
                    '  Python:  python3 -m http.server 8080\n' +
                    '  Node:    npx serve .\n\n' +
                    'Then open http://localhost:8080/planner-import.html'
                );
            } else {
                showError(
                    'Network error — could not reach Anthropic API',
                    'The request was blocked or failed. Possible causes:\n' +
                    '• No internet connection\n' +
                    '• A browser extension (ad blocker, privacy tool) is blocking the request — try disabling it for this page\n' +
                    '• A firewall or VPN is blocking api.anthropic.com'
                );
            }
        } else {
            showError('Could not extract events', err.message || String(err));
        }
    }
}

document.getElementById('analyzeBtn').addEventListener('click', analyzeFile);

// ─── SECTION C: RENDERING ────────────────────────────────────────────────────
function formatDay(isoDate) {
    const d = new Date(isoDate + 'T00:00:00');
    return d.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
}

function initFilters() {
    const container = document.getElementById('filters');
    container.innerHTML = '';
    const categories = [...new Set(events.map(e => e.category).filter(Boolean))].sort();

    if (categories.length === 0) return; // no categories to filter by

    const allBtn = document.createElement('button');
    allBtn.className = 'filter-btn all active';
    allBtn.textContent = 'All';
    allBtn.onclick = () => {
        activeFilters.clear();
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        allBtn.classList.add('active');
        renderEvents();
    };
    container.appendChild(allBtn);

    categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = cat;
        btn.onclick = () => {
            if (activeFilters.has(cat)) {
                activeFilters.delete(cat);
            } else {
                activeFilters.add(cat);
            }
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if (activeFilters.size === 0) {
                allBtn.classList.add('active');
            } else {
                activeFilters.forEach(s => {
                    [...container.children].find(b => b.textContent === s)?.classList.add('active');
                });
            }
            renderEvents();
        };
        container.appendChild(btn);
    });
}

function renderEvents() {
    const container = document.getElementById('eventList');
    const filtered = activeFilters.size === 0
        ? events
        : events.filter(e => e.category && activeFilters.has(e.category));

    if (filtered.length === 0) {
        container.innerHTML = '<div class="no-results">No events match this filter</div>';
        updateCount();
        return;
    }

    const grouped = {};
    filtered.forEach(e => {
        if (!grouped[e.day]) grouped[e.day] = [];
        grouped[e.day].push(e);
    });

    let html = '';
    for (const [day, dayEvents] of Object.entries(grouped)) {
        html += `<div class="day-group"><div class="day-header">${escapeHTML(day)}</div>`;
        dayEvents.forEach(e => {
            const checked = selectedEvents.has(e.idx) ? 'checked' : '';
            const safeIdx = Number(e.idx);
            let tagHtml = '';
            if (e.category) {
                const style = getCategoryStyle(e.category);
                tagHtml = `<span class="category-tag" style="background:${style.bg};color:${style.color}">${escapeHTML(e.category)}</span>`;
            }
            const gcalHref = escapeHTML(getGCalUrl(e));
            const timeLabel = e.allDay ? 'all day' : escapeHTML(e.time);
            html += `
                <div class="event-card" onclick="toggleEvent(${safeIdx}, event)">
                    <input type="checkbox" ${checked} data-idx="${safeIdx}" onclick="event.stopPropagation(); toggleEvent(${safeIdx}, event)">
                    <span class="event-time">${timeLabel}</span>
                    <div class="event-details">
                        <div class="event-title">${tagHtml} ${escapeHTML(e.title)}</div>
                        ${e.description ? `<div class="event-desc">${escapeHTML(e.description)}</div>` : ''}
                        ${e.location ? `<div class="event-loc">&#128205; ${escapeHTML(e.location)}</div>` : ''}
                    </div>
                    <a class="event-gcal" href="${gcalHref}" target="_blank" onclick="event.stopPropagation()">+ Calendar</a>
                </div>`;
        });
        html += '</div>';
    }
    container.innerHTML = html;
    updateCount();
}

function toggleEvent(idx, evt) {
    if (evt.target.tagName === 'A') return;
    if (selectedEvents.has(idx)) {
        selectedEvents.delete(idx);
    } else {
        selectedEvents.add(idx);
    }
    const cb = document.querySelector(`input[data-idx="${Number(idx)}"]`);
    if (cb) cb.checked = selectedEvents.has(idx);
    updateCount();
}

function updateCount() {
    const count = selectedEvents.size;
    document.getElementById('countBadge').textContent = `${count} selected`;
    document.getElementById('floatingCount').textContent = `${count} selected`;
    const hasSelected = count > 0;
    document.getElementById('floatingBar').classList.toggle('visible', hasSelected);
    document.getElementById('downloadIcs').disabled = !hasSelected;
}

document.getElementById('selectAll').addEventListener('change', function() {
    const filtered = activeFilters.size === 0
        ? events
        : events.filter(e => e.category && activeFilters.has(e.category));
    if (this.checked) {
        filtered.forEach(e => selectedEvents.add(e.idx));
    } else {
        filtered.forEach(e => selectedEvents.delete(e.idx));
    }
    document.querySelectorAll('.event-card input[type="checkbox"]').forEach(cb => {
        cb.checked = this.checked;
    });
    updateCount();
});

// ─── SECTION D: ICS / GCAL EXPORT ────────────────────────────────────────────
function getGCalUrl(event) {
    const [h, m] = event.time.split(':');
    const start = new Date(event.date + 'T' + h.padStart(2,'0') + ':' + m.padStart(2,'0') + ':00');
    const durationMs = event.duration_minutes ? event.duration_minutes * 60000 : 3600000;
    const end = new Date(start.getTime() + durationMs);
    const fmt = d => d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    const title = event.category ? `${event.category}: ${event.title}` : event.title;
    const details = event.description || '';
    const location = event.location || '';
    return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${fmt(start)}/${fmt(end)}&details=${encodeURIComponent(details)}&location=${encodeURIComponent(location)}`;
}

function toICSDate(date, time) {
    const [h, m] = time.split(':');
    return date.replace(/-/g, '') + 'T' + h.padStart(2,'0') + m.padStart(2,'0') + '00';
}

function toICSEndDate(date, time, duration_minutes) {
    const [h, m] = time.split(':');
    const start = new Date(date + 'T' + h.padStart(2,'0') + ':' + m.padStart(2,'0') + ':00');
    const durationMs = duration_minutes ? duration_minutes * 60000 : 3600000;
    const end = new Date(start.getTime() + durationMs);
    const pad = n => String(n).padStart(2, '0');
    return end.getFullYear() + pad(end.getMonth()+1) + pad(end.getDate()) + 'T' + pad(end.getHours()) + pad(end.getMinutes()) + '00';
}

function escapeICS(str) {
    return str.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
}

function escapeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function icsLine(line) {
    return line + '\r\n';
}

function generateICS(indices) {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    const dtstamp = now.getUTCFullYear() + pad(now.getUTCMonth()+1) + pad(now.getUTCDate()) + 'T' +
        pad(now.getUTCHours()) + pad(now.getUTCMinutes()) + pad(now.getUTCSeconds()) + 'Z';

    let ics = '';
    ics += icsLine('BEGIN:VCALENDAR');
    ics += icsLine('VERSION:2.0');
    ics += icsLine('PRODID:-//PlannerImport//EN');
    ics += icsLine('CALSCALE:GREGORIAN');
    ics += icsLine('X-WR-CALNAME:Imported Schedule');
    ics += icsLine('BEGIN:VTIMEZONE');
    ics += icsLine('TZID:UTC');
    ics += icsLine('BEGIN:STANDARD');
    ics += icsLine('DTSTART:19700101T000000');
    ics += icsLine('TZOFFSETFROM:+0000');
    ics += icsLine('TZOFFSETTO:+0000');
    ics += icsLine('TZNAME:UTC');
    ics += icsLine('END:STANDARD');
    ics += icsLine('END:VTIMEZONE');

    indices.forEach(idx => {
        const e = events[idx];
        if (!e) return;
        const uid = `planner-${e.date}-${e.time.replace(':','')}-${idx}@planner-import`;
        const summary = escapeICS(e.category ? `${e.category}: ${e.title}` : e.title);
        const description = e.description ? escapeICS(e.description) : '';
        const location = e.location ? escapeICS(e.location) : '';

        ics += icsLine('BEGIN:VEVENT');
        ics += icsLine(`UID:${uid}`);
        ics += icsLine(`DTSTAMP:${dtstamp}`);

        if (e.allDay) {
            ics += icsLine(`DTSTART;VALUE=DATE:${e.date.replace(/-/g, '')}`);
            ics += icsLine(`DTEND;VALUE=DATE:${e.date.replace(/-/g, '')}`);
        } else {
            const dtstart = toICSDate(e.date, e.time);
            const dtend = toICSEndDate(e.date, e.time, e.duration_minutes);
            ics += icsLine(`DTSTART;TZID=UTC:${dtstart}`);
            ics += icsLine(`DTEND;TZID=UTC:${dtend}`);
        }

        ics += icsLine(`SUMMARY:${summary}`);
        if (description) ics += icsLine(`DESCRIPTION:${description}`);
        if (location) ics += icsLine(`LOCATION:${location}`);
        ics += icsLine('STATUS:CONFIRMED');
        ics += icsLine('END:VEVENT');
    });

    ics += icsLine('END:VCALENDAR');
    return ics;
}

function downloadICS() {
    const selected = [...selectedEvents].sort((a,b) => a - b);
    if (selected.length === 0) return;

    const icsContent = generateICS(selected);
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobile) {
        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        window.location.href = url;
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    } else {
        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'schedule.ics';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
}

document.getElementById('downloadIcs').addEventListener('click', downloadICS);
document.getElementById('floatingDownloadIcs').addEventListener('click', downloadICS);

// ─── SECTION E: PHASE / STATE MACHINE ────────────────────────────────────────
function showPhase(phase) {
    document.getElementById('phase-upload').classList.toggle('hidden', phase !== 'upload');
    document.getElementById('phase-processing').classList.toggle('hidden', phase !== 'processing');
    document.getElementById('phase-error').classList.toggle('hidden', phase !== 'error');
    document.getElementById('phase-results').classList.toggle('hidden', phase !== 'results');
    document.getElementById('floatingBar').classList.remove('visible');
}

function showError(title, detail) {
    document.getElementById('errorDetail').textContent = detail || '';
    document.querySelector('.error-title').textContent = title;
    showPhase('error');
}

document.getElementById('retryBtn').addEventListener('click', () => showPhase('upload'));
document.getElementById('importAnother').addEventListener('click', () => {
    events = [];
    selectedEvents.clear();
    activeFilters.clear();
    resetFileState();
    document.getElementById('filters').innerHTML = '';
    document.getElementById('eventList').innerHTML = '';
    showPhase('upload');
});

// Start on upload phase
showPhase('upload');
</script>
</body>
</html>
